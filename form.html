<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Formulaire de Non Conformité</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css">
</head>

<body>
    <div class="container">

        <div class="py-5 text-center">
            <h2>Formulaire de non conformité</h2>
            <p class="lead">Remplir le formulaire de non-conformité et l'enregistrer dans le dossier "non-conformité"
                sur votre bureau.</p>
        </div>

        <form id="form-non-conformite" class="needs-validation" novalidate>

            <div class="form-row justify-content-between">

                <div class="form-group col-md-5">
                    <label for="datePicker">Date</label>
                    <input type="date" class="form-control" id="datePicker" required>
                    <div class="invalid-feedback">
                        Entrer une date valide.
                    </div>
                </div>
                <div class="form-group col-md-5">
                    <label for="nom">Nom complet du déclarant</label>
                    <input type="text" class="form-control" placeholder="Prénom Nom" required name="nom">
                    <div class="invalid-feedback">
                        Entrer votre nom complet.
                    </div>
                </div>
            </div>

            <div class="form-row justify-content-between">
                <div class="form-group col-md-5">
                    <label for="provenance">Provenance</label>
                    <div>
                        <select id="provenance" name="provenance" class="custom-select" required> </select>
                        <div class="invalid-feedback">
                            Sélectionner une provenance.
                        </div>
                    </div>
                </div>
                <div class="form-group col-md-5">
                    <label for="departement">Département</label>
                    <div>
                        <select id="departement" name="departement" class="custom-select" required> </select>
                        <div class="invalid-feedback">
                            Sélectionner un département.
                        </div>
                    </div>
                </div>

            </div>

            <div class="form-row justify-content-between">
                <div class="form-group col-md-5">
                    <label for="type">Type de non-conformité</label>
                    <div>
                        <select id="type" name="type" class="custom-select" required> </select>
                        <div class="invalid-feedback">
                            Sélectionner un type.
                        </div>
                    </div>
                </div>

                <div class="form-group col-md-5">
                    <label for="numRequete"># de requête
                        <span class="text-muted">(optionnel)</span>
                    </label>
                    <input type="text" class="form-control" id="numRequete">
                    <div class="invalid-feedback">
                        Numéro de requête invalide.
                    </div>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group col-md-12">
                    <label for="descriptifSelect">Descriptif</label>
                    <div id="descriptifList">
                        <select id="descriptifSelect" name="descriptif" class="custom-select" required> </select>
                        <div class="invalid-feedback">
                            Sélectionner un descriptif.
                        </div>
                    </div>
                    <div>
                        <input id="descriptifInput" name="descriptif" class="form-control d-none"> </input>
                    </div>
                </div>
            </div>

            <hr>

            <div class="form-group">
                <label for="actionImm">Action immédiate - Dérogation</label>
                <textarea class="form-control" id="actionImm" rows="3" required></textarea>
            </div>

            <div class="form-group">
                <label for="impact">Impact/Étendue de la non-conformité</label>
                <textarea class="form-control" id="impact" rows="3" required></textarea>
            </div>

            <div class="form-group">
                <label for="cause">Cause profonde</label>
                <textarea class="form-control" id="cause" rows="3" required></textarea>
            </div>

            <div class="form-row">
                <div class="form-group col-md-12">
                    <div class="custom-control custom-checkbox">
                        <input type="checkbox" class="custom-control-input" id="ah223">
                        <label class="custom-control-label" for="ah223">Cocher si AH-223</label>
                    </div>
                </div>
            </div>


            <div class="form-group mt-5 col-md-10 offset-md-1">
                <button type="submit" class="btn btn-primary btn-block">Enregistrer</button>
            </div>
        </form>
    </div>


    <footer class="my-5 pt-5 text-muted text-center text-small">
        <p class="mb-1">© 2020 Marc-André Bourassa</p>
    </footer>



    <script>

        const departements = [
            "",
            "Biochimie",
            "Hématologie",
            "Banque de sang",
            "Microbiologie",
            "Sérologie",
            "Cytologie",
            "Laboratoire général"
        ]

        const provenances = [
            "",
            "Laboratoire",
            "Urgence",
            "Soins intensifs",
            "4 Nord",
            "5 Nord",
            "5 Sud",
            "6 Nord",
            "6 Sud",
            "7 Nord",
            "7 Sud",
            "Clinique Privé",
            "Centre de prélèvement",
            "Autre",
        ]

        const types = [
            "",
            "Pré-analytique",
            "Analytique",
            "Post-analytique",
            "Autre"
        ]

        const descriptifsPre = [
            "",
            "Mauvais type tube ou milieu de transport inadéquat",
            "Quantité insuffisante ou inadéquate",
            "Stabilisation inadéquate"
        ]

        const descriptifAnalytique = [
            "",
            "test analytique"
        ]

        const descriptifPost = [
            ""
        ]


        window.addEventListener("load", () => {
            //Validation
            const form = document.getElementById("form-non-conformite");
            const inputs = form.elements;
            form.addEventListener("submit", e => {
                form.classList.add("was-validated");
                e.preventDefault();
                if (form.checkValidity()) {
                    exportTableToCSV(inputs);
                }
            });

            //Remplissage des menus déroulants
            document.getElementById('datePicker').valueAsDate = new Date();

            let departementSelect = document.getElementById('departement');
            departements.forEach((dep, index) => {
                departementSelect[index] = new Option(dep, dep)
            })

            let typeSelect = document.getElementById('type');
            types.forEach((type, index) => {
                typeSelect[index] = new Option(type, type)
            })

            let provenanceSelect = document.getElementById('provenance');
            provenances.forEach((provenance, index) => {
                provenanceSelect[index] = new Option(provenance, provenance)
            })

            document.getElementById("type").addEventListener("change", e => {
                let descriptifSelect = document.getElementById('descriptifSelect');
                inputField = document.getElementById("descriptifInput");
                selectField = document.getElementById("descriptifList");
                impactField = document.getElementById("impact");
                causeField = document.getElementById("cause");

                inputField.classList.add("d-none");
                selectField.classList.remove("d-none");
                impactField.removeAttribute("disabled");
                causeField.removeAttribute("disabled");

                let descriptifs;
                if (e.target.value === "Autre") {
                    inputField.classList.remove("d-none");
                    selectField.classList.add("d-none");
                } else {
                    if (e.target.value === "Pré-analytique") {
                        descriptifs = descriptifsPre
                        impactField.setAttribute("disabled", "");
                        causeField.setAttribute("disabled", "");

                    } else if (e.target.value === "Analytique") {
                        descriptifs = descriptifAnalytique;

                    } else if (e.target.value === "Post-analytique") {
                        descriptifs = descriptifPost;
                    }

                    descriptifSelect.options.length = 0;
                    descriptifs.forEach((descriptif, index) => {
                        descriptifSelect[index] = new Option(descriptif, descriptif)
                    })
                }
            });
        });

        function exportTableToCSV(inputs) {

            let csv = "Date;Nom;Provenance;Département;Type NC;#requête;Descriptif;Action immédiate;Impact;Cause;AH-223;\
            Mesures à entreprendre pour corriger la situation;Échéancier (30 jours);Responsable;Échéancier (90 jours);Efficacité - Suivi\n";
            let ah223 = document.getElementById("ah223")
            ah223.value = ah223.checked ? "Oui" : "Non";

            let separator = "";
            let values = [...inputs]

            let descriptif = document.getElementById('descriptifSelect');
            if (descriptif.value) {
                values = values.filter(elem => elem.id !== "descriptifInput");
            } else {
                values = values.filter(elem => elem.id !== "descriptifSelect");
            }

            values.forEach(element => {
                csv += separator + element.value;
                separator = ";";

            });

            let csvFile = new Blob([csv], { type: "text/csv;charset=utf-8" });

            // Download link
            let downloadLink = document.createElement("a");

            // File name
            downloadLink.download = `NC_${inputs[4].value}_${inputs[5].value}_${new Date().toLocaleString()}.csv`;

            // Create a link to the file
            downloadLink.href = window.URL.createObjectURL(csvFile);

            // Hide download link
            downloadLink.style.display = "none";

            // Add the link to DOM
            document.body.appendChild(downloadLink);

            // Click download link
            downloadLink.click();
        }



    </script>

    <style>
        body {
            background-color: #f8f9fa;
        }

        .container {
            max-width: 960px;
        }
    </style>

</body>

</html>